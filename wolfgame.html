<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Village - Jeu multijoueur</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* Reset et base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            image-rendering: pixelated;
        }
        
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #1a1a2e;
            color: #e6e6e6;
            line-height: 1.6;
            overflow-x: hidden;
            background-image: url('https://i.imgur.com/8ZXRIQ3.png');
            background-size: 200px;
        }
        
        /* Animation de feu de camp */
        @keyframes campfire {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }
        
        .campfire {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 100px;
            height: 100px;
            background-image: url('https://i.imgur.com/Xd8W3Ry.gif');
            background-size: contain;
            background-repeat: no-repeat;
            animation: campfire 2s infinite;
            z-index: 1;
            pointer-events: none;
        }
        
        /* √âtoiles scintillantes */
        @keyframes twinkle {
            0% { opacity: 0.2; }
            50% { opacity: 1; }
            100% { opacity: 0.2; }
        }
        
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%"><circle cx="10%" cy="15%" r="1" fill="white"/><circle cx="25%" cy="30%" r="1" fill="white"/><circle cx="50%" cy="10%" r="1" fill="white"/><circle cx="75%" cy="25%" r="1" fill="white"/><circle cx="90%" cy="40%" r="1" fill="white"/><circle cx="15%" cy="70%" r="1" fill="white"/><circle cx="40%" cy="80%" r="1" fill="white"/><circle cx="60%" cy="60%" r="1" fill="white"/><circle cx="85%" cy="75%" r="1" fill="white"/></svg>');
            z-index: -1;
            pointer-events: none;
        }
        
        .night-mode .stars {
            animation: twinkle 3s infinite;
        }
        
        /* Styles globaux pixel art */
        .pixel-border {
            border: 4px solid #4a4a4a;
            border-image: repeating-linear-gradient(45deg, #4a4a4a, #4a4a4a 2px, #333 2px, #333 4px) 4;
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
            background-color: #2d2d44;
            position: relative;
            overflow: hidden;
        }
        
        .pixel-border::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #4a752c, #6a953c);
        }
        
        .pixel-button {
            background-color: #4a752c;
            color: white;
            border: none;
            padding: 12px 24px;
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            margin: 10px;
            text-shadow: 2px 2px 0 #1a1a2e;
        }
        
        .pixel-button:hover {
            background-color: #5e8c3e;
            transform: translate(-2px, -2px);
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
        }
        
        .pixel-button:active {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0 rgba(0, 0, 0, 0.3);
        }
        
        .pixel-input {
            background-color: #2d2d44;
            border: 3px solid #4a4a4a;
            padding: 10px;
            font-family: 'Press Start 2P', cursive;
            color: white;
            margin: 10px 0;
            width: 100%;
            max-width: 300px;
        }
        
        /* Animation d'√©criture */
        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }
        
        .typing-animation {
            overflow: hidden;
            white-space: nowrap;
            animation: typing 3s steps(40, end);
        }
        
        /* Layout principal */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 2;
        }
        
        /* Page d'accueil */
        .home-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            position: relative;
        }
        
        .game-title {
            font-size: 3rem;
            margin-bottom: 2rem;
            color: #f0f0f0;
            text-shadow: 4px 4px 0 #4a752c, 8px 8px 0 #1a1a2e;
            position: relative;
        }
        
        .game-title::after {
            content: "";
            display: block;
            width: 100%;
            height: 8px;
            background: linear-gradient(90deg, #4a752c, #6a953c);
            margin-top: 10px;
        }
        
        .player-form {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: rgba(26, 26, 46, 0.8);
            padding: 2rem;
            border-radius: 8px;
            position: relative;
            backdrop-filter: blur(5px);
        }
        
        /* Animation soleil/lune */
        .sun-moon {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-image: url('https://i.imgur.com/KYjQJZR.png');
            background-size: contain;
            z-index: 10;
            transition: transform 1s;
        }
        
        .night-mode .sun-moon {
            background-image: url('https://i.imgur.com/9mQZbBx.png');
            transform: rotate(180deg);
        }
        
        /* Lobby */
        .lobby-screen {
            display: none;
            min-height: 100vh;
            padding: 20px;
        }
        
        .player-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .player-card {
            background-color: #2d2d44;
            padding: 15px;
            border-radius: 8px;
            width: 150px;
            text-align: center;
            position: relative;
            transition: transform 0.3s;
        }
        
        .player-card:hover {
            transform: translateY(-5px);
        }
        
        .player-card::after {
            content: "";
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 5px;
            background-color: #4a752c;
        }
        
        /* √âcran de jeu */
        .game-screen {
            display: none;
            min-height: 100vh;
            padding: 20px;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .game-phase {
            font-size: 1.5rem;
            color: #f0f0f0;
            text-shadow: 2px 2px 0 #1a1a2e;
        }
        
        .game-timer {
            font-size: 1.2rem;
            color: #f0f0f0;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
        }
        
        .narration-box {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #4a752c;
            position: relative;
        }
        
        .narration-box::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #4a752c, #6a953c);
        }
        
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 300px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
        }
        
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background-color: rgba(26, 26, 46, 0.5);
            border-radius: 5px;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex-grow: 1;
            padding: 10px;
            font-family: 'Press Start 2P', cursive;
            background-color: #2d2d44;
            color: white;
            border: none;
            border-radius: 5px;
        }
        
        /* √âcran de r√¥le */
        .role-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            backdrop-filter: blur(5px);
        }
        
        .role-emoji {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .role-description {
            font-size: 1.5rem;
            margin-bottom: 30px;
            max-width: 80%;
            line-height: 1.8;
        }
        
        /* Mode nuit */
        .night-mode {
            background-color: #0a0a1a;
            color: #a0a0a0;
        }
        
        .night-mode .pixel-button {
            background-color: #3a3a6a;
        }
        
        /* Animation de transition */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 1s ease-in;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .game-title {
                font-size: 2rem;
            }
            
            .player-card {
                width: 120px;
                font-size: 0.8rem;
            }
            
            .role-description {
                font-size: 1rem;
            }
            
            .pixel-button {
                padding: 8px 16px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- √âl√©ments d'arri√®re-plan -->
    <div class="stars"></div>
    <div class="campfire"></div>
    <div class="sun-moon"></div>
    
    <!-- √âcran d'accueil -->
    <div class="home-screen fade-in">
        <div class="container">
            <h1 class="game-title">LE VILLAGE</h1>
            <div class="player-form pixel-border">
                <input type="text" id="player-name" class="pixel-input" placeholder="Ton pseudo" maxlength="15">
                <button id="create-game-btn" class="pixel-button">Cr√©er une partie</button>
                <div style="margin: 15px 0; position: relative;">
                    <div style="position: absolute; top: 50%; left: 0; right: 0; height: 2px; background-color: #4a4a4a;"></div>
                    <span style="background-color: #1a1a2e; padding: 0 10px; position: relative;">OU</span>
                </div>
                <input type="text" id="game-id" class="pixel-input" placeholder="Code de la partie">
                <button id="join-game-btn" class="pixel-button">Rejoindre</button>
            </div>
        </div>
    </div>
    
    <!-- Lobby -->
    <div class="lobby-screen pixel-border">
        <div class="container">
            <h2>Place du Village</h2>
            <p id="game-code-display">Code de la partie: </p>
            <div class="player-list" id="player-list">
                <!-- Joueurs seront ajout√©s ici dynamiquement -->
            </div>
            
            <div id="game-settings" style="margin-top: 30px;">
                <h3>Param√®tres de la partie</h3>
                <div id="role-selection" style="margin: 15px 0;">
                    <h4>R√¥les disponibles:</h4>
                    <!-- Cases √† cocher pour les r√¥les -->
                </div>
                
                <div style="margin: 15px 0;">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="allow-spectators" class="pixel-input" style="width: auto;">
                        Autoriser les spectateurs
                    </label>
                </div>
                
                <div style="margin: 15px 0;">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="radio" name="narrator" id="auto-narrator" checked class="pixel-input" style="width: auto;">
                        Narration automatique
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="radio" name="narrator" id="manual-narrator" class="pixel-input" style="width: auto;">
                        Narration manuelle
                    </label>
                </div>
                
                <button id="start-game-btn" class="pixel-button" disabled>Commencer la nuit</button>
            </div>
        </div>
    </div>
    
    <!-- √âcran de jeu principal -->
    <div class="game-screen pixel-border">
        <div class="container">
            <div class="game-header">
                <div class="game-phase" id="game-phase">‚òÄÔ∏è Jour 1</div>
                <div class="game-timer" id="game-timer">‚è±Ô∏è 02:00</div>
            </div>
            
            <div class="narration-box" id="narration-box">
                <!-- Narration du jeu -->
            </div>
            
            <div class="action-buttons" id="action-buttons">
                <!-- Boutons d'action selon le r√¥le et la phase -->
            </div>
            
            <div class="player-list" id="alive-players">
                <!-- Joueurs en vie -->
            </div>
            
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <!-- Messages de chat -->
                </div>
                <div class="chat-input-container">
                    <input type="text" id="chat-input" class="chat-input" placeholder="√âcrire un message...">
                    <button id="send-chat-btn" class="pixel-button" style="margin: 0;">Envoyer</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- √âcran de r√¥le -->
    <div class="role-screen" id="role-screen">
        <div class="role-emoji" id="role-emoji">üë§</div>
        <div class="role-description" id="role-description">Tu es un Villageois</div>
        <button id="confirm-role-btn" class="pixel-button">Je suis pr√™t</button>
    </div>
    
    <!-- Sons du jeu -->
    <audio id="bg-music" loop>
        <source src="https://assets.codepen.io/21542/stardew-valley-theme.mp3" type="audio/mpeg">
    </audio>
    <audio id="night-sound">
        <source src="https://assets.codepen.io/21542/werewolf-how.mp3" type="audio/mpeg">
    </audio>
    <audio id="day-sound">
        <source src="https://assets.codepen.io/21542/birds-chirping.mp3" type="audio/mpeg">
    </audio>
    
    <!-- Firebase et scripts du jeu -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    
    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAfWw2bWiJEfVrYDBhCuaG65b55qhbVma0",
            authDomain: "chat-entre-amis.firebaseapp.com",
            projectId: "chat-entre-amis",
            storageBucket: "chat-entre-amis.appspot.com",
            messagingSenderId: "515377701483",
            appId: "1:515377701483:web:0f81538de26d5904f9472e"
        };
        
        // Initialisation Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Activer la persistance des donn√©es
        firebase.firestore().enablePersistence()
            .catch((err) => {
                console.error("Erreur de persistance Firestore:", err);
            });
        
        // Variables globales du jeu
        let currentGameId = null;
        let currentPlayerId = null;
        let currentPlayerName = "";
        let currentPlayerRole = "";
        let isGameCreator = false;
        let gameState = {};
        let players = {};
        let gameUnsubscribe = null;
        let chatUnsubscribe = null;
        let nightActionsUnsubscribe = null;
        let votesUnsubscribe = null;
        
        // R√¥les disponibles
        const ROLES = {
            VILLAGER: { emoji: "üë§", name: "Villageois", description: "Tu es un simple villageois. Ton but est d'√©liminer tous les Loups-Garous." },
            WEREWOLF: { emoji: "üê∫", name: "Loup-Garou", description: "Tu es un Loup-Garou. Chaque nuit, tu dois choisir une victime avec tes comp√®res." },
            SEER: { emoji: "üîÆ", name: "Voyante", description: "Tu peux d√©couvrir le r√¥le d'un joueur chaque nuit." },
            WITCH: { emoji: "üßô", name: "Sorci√®re", description: "Tu poss√®des une potion de vie et une potion de mort. Utilise-les avec sagesse." },
            CUPID: { emoji: "üíò", name: "Cupidon", description: "La premi√®re nuit, tu dois former un couple de deux joueurs qui devront survivre ensemble." },
            HUNTER: { emoji: "üèπ", name: "Chasseur", description: "Si tu meurs, tu peux emporter quelqu'un avec toi." },
            LITTLE_GIRL: { emoji: "üëß", name: "Petite Fille", description: "Tu peux espionner les Loups-Garous la nuit, mais si tu es d√©couverte, tu meurs." }
        };
        
        // Phases du jeu
        const GAME_PHASES = {
            LOBBY: "lobby",
            ROLE_ASSIGNMENT: "role_assignment",
            NIGHT: "night",
            DAY: "day",
            VOTING: "voting",
            END: "end"
        };
        
        // Phases de nuit
        const NIGHT_PHASES = {
            CUPID: "cupid",
            WEREWOLVES: "werewolves",
            SEER: "seer",
            WITCH: "witch"
        };
        
        // Initialisation de l'application
        document.addEventListener('DOMContentLoaded', () => {
            // D√©marrer la musique de fond
            const bgMusic = document.getElementById('bg-music');
            bgMusic.volume = 0.3;
            bgMusic.play().catch(e => console.log("La lecture automatique a √©t√© bloqu√©e:", e));
            
            // √âcouteurs d'√©v√©nements
            document.getElementById('create-game-btn').addEventListener('click', createGame);
            document.getElementById('join-game-btn').addEventListener('click', joinGame);
            document.getElementById('start-game-btn').addEventListener('click', startGame);
            document.getElementById('confirm-role-btn').addEventListener('click', confirmRole);
            document.getElementById('send-chat-btn').addEventListener('click', sendChatMessage);
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });
            
            // V√©rifier si on revient √† une partie
            checkReturningPlayer();
        });
        
        // Fonction pour cr√©er une nouvelle partie
        async function createGame() {
            const playerName = document.getElementById('player-name').value.trim();
            if (!playerName) {
                alert("Choisis un pseudo !");
                return;
            }
            
            currentPlayerName = playerName;
            sessionStorage.setItem('playerName', playerName);
            
            try {
                // Cr√©er une partie avec un ID al√©atoire
                currentGameId = generateGameId();
                isGameCreator = true;
                
                // Authentification anonyme
                await auth.signInAnonymously();
                currentPlayerId = auth.currentUser.uid;
                
                // Cr√©er le document de la partie dans Firestore
                await db.collection('games').doc(currentGameId).set({
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: GAME_PHASES.LOBBY,
                    settings: {
                        roles: Object.keys(ROLES),
                        allowSpectators: false,
                        narratorType: "auto"
                    },
                    phase: "night_1",
                    phaseStep: NIGHT_PHASES.CUPID,
                    currentDay: 1
                });
                
                // Ajouter le joueur √† la partie
                await db.collection('games').doc(currentGameId).collection('players').doc(currentPlayerId).set({
                    pseudo: currentPlayerName,
                    role: "",
                    isAlive: true,
                    type: "player",
                    score: 0,
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Afficher le lobby
                showLobbyScreen();
                
                // √âcouter les changements de la partie
                setupGameListener();
                
            } catch (error) {
                console.error("Erreur lors de la cr√©ation de la partie:", error);
                alert("Une erreur est survenue lors de la cr√©ation de la partie. V√©rifie ta connexion internet.");
            }
        }
        
        // Fonction pour rejoindre une partie existante
        async function joinGame() {
            const playerName = document.getElementById('player-name').value.trim();
            const gameId = document.getElementById('game-id').value.trim().toUpperCase();
            
            if (!playerName) {
                alert("Choisis un pseudo !");
                return;
            }
            
            if (!gameId) {
                alert("Entre le code de la partie !");
                return;
            }
            
            currentPlayerName = playerName;
            currentGameId = gameId;
            sessionStorage.setItem('playerName', playerName);
            sessionStorage.setItem('gameId', gameId);
            
            try {
                // V√©rifier si la partie existe
                const gameDoc = await db.collection('games').doc(gameId).get();
                if (!gameDoc.exists) {
                    alert("Aucune partie trouv√©e avec ce code !");
                    return;
                }
                
                // Authentification anonyme
                await auth.signInAnonymously();
                currentPlayerId = auth.currentUser.uid;
                
                // Rejoindre la partie
                await db.collection('games').doc(currentGameId).collection('players').doc(currentPlayerId).set({
                    pseudo: currentPlayerName,
                    role: "",
                    isAlive: true,
                    type: "player",
                    score: 0,
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Afficher le lobby
                showLobbyScreen();
                
                // √âcouter les changements de la partie
                setupGameListener();
                
            } catch (error) {
                console.error("Erreur lors de la connexion √† la partie:", error);
                alert("Une erreur est survenue lors de la connexion √† la partie. V√©rifie ta connexion internet.");
            }
        }
        
        // Fonction pour v√©rifier si un joueur revient √† une partie
        async function checkReturningPlayer() {
            const savedPlayerName = sessionStorage.getItem('playerName');
            const savedGameId = sessionStorage.getItem('gameId');
            
            if (savedPlayerName && savedGameId) {
                document.getElementById('player-name').value = savedPlayerName;
                document.getElementById('game-id').value = savedGameId;
                
                // V√©rifier si la partie existe toujours
                try {
                    const gameDoc = await db.collection('games').doc(savedGameId).get();
                    if (gameDoc.exists) {
                        currentPlayerName = savedPlayerName;
                        currentGameId = savedGameId;
                        
                        // Authentification anonyme
                        await auth.signInAnonymously();
                        currentPlayerId = auth.currentUser.uid;
                        
                        // V√©rifier si le joueur est d√©j√† dans la partie
                        const playerDoc = await db.collection('games').doc(currentGameId).collection('players').doc(currentPlayerId).get();
                        
                        if (!playerDoc.exists) {
                            // Rejoindre la partie
                            await db.collection('games').doc(currentGameId).collection('players').doc(currentPlayerId).set({
                                pseudo: currentPlayerName,
                                role: "",
                                isAlive: true,
                                type: "player",
                                score: 0,
                                joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        } else {
                            // Mettre √† jour le pseudo au cas o√π il a chang√©
                            await db.collection('games').doc(currentGameId).collection('players').doc(currentPlayerId).update({
                                pseudo: currentPlayerName
                            });
                            
                            currentPlayerRole = playerDoc.data().role;
                        }
                        
                        // Afficher l'√©cran appropri√©
                        if (gameDoc.data().status === GAME_PHASES.LOBBY) {
                            showLobbyScreen();
                        } else {
                            showGameScreen();
                        }
                        
                        // √âcouter les changements de la partie
                        setupGameListener();
                    }
                } catch (error) {
                    console.error("Erreur lors de la v√©rification de la partie:", error);
                }
            }
        }
        
        // Fonction pour afficher l'√©cran de lobby
        function showLobbyScreen() {
            document.querySelector('.home-screen').style.display = 'none';
            document.querySelector('.lobby-screen').style.display = 'block';
            document.querySelector('.game-screen').style.display = 'none';
            
            document.getElementById('game-code-display').textContent = `Code de la partie: ${currentGameId}`;
            
            // Si cr√©ateur, afficher les param√®tres
            if (isGameCreator) {
                document.getElementById('game-settings').style.display = 'block';
                document.getElementById('start-game-btn').disabled = false;
                
                // Remplir les options de r√¥les
                const roleSelection = document.getElementById('role-selection');
                roleSelection.innerHTML = '<h4>R√¥les disponibles:</h4>';
                
                Object.entries(ROLES).forEach(([key, role]) => {
                    const div = document.createElement('div');
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                    div.style.gap = '10px';
                    div.style.margin = '5px 0';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `role-${key}`;
                    checkbox.value = key;
                    checkbox.checked = true;
                    checkbox.className = 'pixel-input';
                    checkbox.style.width = 'auto';
                    
                    const label = document.createElement('label');
                    label.htmlFor = `role-${key}`;
                    label.textContent = `${role.emoji} ${role.name}`;
                    
                    div.appendChild(checkbox);
                    div.appendChild(label);
                    roleSelection.appendChild(div);
                });
            } else {
                document.getElementById('game-settings').style.display = 'none';
                document.getElementById('start-game-btn').disabled = true;
            }
        }
        
        // Fonction pour d√©marrer le jeu
        async function startGame() {
            if (!isGameCreator) return;
            
            // R√©cup√©rer les r√¥les s√©lectionn√©s
            const selectedRoles = [];
            document.querySelectorAll('#role-selection input[type="checkbox"]:checked').forEach(checkbox => {
                selectedRoles.push(checkbox.value);
            });
            
            if (selectedRoles.length === 0) {
                alert("S√©lectionne au moins un r√¥le !");
                return;
            }
            
            // V√©rifier le nombre minimum de joueurs
            const playersSnapshot = await db.collection('games').doc(currentGameId).collection('players').get();
            if (playersSnapshot.size < 4) {
                alert("Il faut au moins 4 joueurs pour commencer une partie !");
                return;
            }
            
            // Mettre √† jour les param√®tres de la partie
            await db.collection('games').doc(currentGameId).update({
                'settings.roles': selectedRoles,
                'settings.allowSpectators': document.getElementById('allow-spectators').checked,
                'settings.narratorType': document.getElementById('auto-narrator').checked ? 'auto' : 'manual',
                status: GAME_PHASES.ROLE_ASSIGNMENT
            });
        }
        
        // Fonction pour attribuer les r√¥les aux joueurs
        async function assignRoles(gameData) {
            const playersSnapshot = await db.collection('games').doc(currentGameId).collection('players').get();
            const playersList = playersSnapshot.docs.map(doc => doc.id);
            const availableRoles = [...gameData.settings.roles];
            
            // M√©langer les r√¥les disponibles
            shuffleArray(availableRoles);
            
            // Calculer le nombre de loups-garous selon les r√®gles officielles
            const totalPlayers = playersList.length;
            const werewolvesCount = Math.max(1, Math.floor(totalPlayers / 4));
            
            // S'assurer qu'il y a au moins 1 loup-garou
            if (!availableRoles.includes('WEREWOLF')) {
                availableRoles.push('WEREWOLF');
            }
            
            // Attribuer les r√¥les aux joueurs
            const updates = [];
            let werewolvesAssigned = 0;
            
            for (let i = 0; i < playersList.length; i++) {
                let role;
                
                // Assigner les loups-garous en premier
                if (werewolvesAssigned < werewolvesCount && availableRoles.includes('WEREWOLF')) {
                    role = 'WEREWOLF';
                    werewolvesAssigned++;
                    availableRoles.splice(availableRoles.indexOf('WEREWOLF'), 1);
                } else {
                    // Assigner les autres r√¥les
                    role = availableRoles.length > 0 ? availableRoles.shift() : 'VILLAGER';
                }
                
                updates.push(
                    db.collection('games').doc(currentGameId).collection('players').doc(playersList[i]).update({
                        role: role,
                        isAlive: true,
                        loverUid: null
                    })
                );
            }
            
            await Promise.all(updates);
            
            // Passer √† la premi√®re nuit
            await db.collection('games').doc(currentGameId).update({
                status: GAME_PHASES.NIGHT,
                phase: "night_1",
                phaseStep: NIGHT_PHASES.CUPID,
                currentDay: 1
            });
        }
        
        // Fonction pour afficher l'√©cran de r√¥le
        function showRoleScreen(role) {
            // Jouer un son sp√©cial pour certains r√¥les
            if (role === 'WEREWOLF') {
                document.getElementById('night-sound').play();
            }
            
            document.getElementById('role-emoji').textContent = ROLES[role].emoji;
            document.getElementById('role-description').textContent = `Tu es ${ROLES[role].name}\n\n${ROLES[role].description}`;
            document.querySelector('.role-screen').style.display = 'flex';
            
            // Stocker le r√¥le du joueur
            currentPlayerRole = role;
        }
        
        // Fonction pour confirmer la vue du r√¥le
        function confirmRole() {
            document.querySelector('.role-screen').style.display = 'none';
            showGameScreen();
        }
        
        // Fonction pour afficher l'√©cran de jeu principal
        function showGameScreen() {
            document.querySelector('.home-screen').style.display = 'none';
            document.querySelector('.lobby-screen').style.display = 'none';
            document.querySelector('.game-screen').style.display = 'block';
            
            // Mettre √† jour l'interface selon l'√©tat du jeu
            updateGameInterface();
        }
        
        // Fonction pour configurer l'√©couteur de la partie
        function setupGameListener() {
            if (gameUnsubscribe) gameUnsubscribe();
            if (chatUnsubscribe) chatUnsubscribe();
            if (nightActionsUnsubscribe) nightActionsUnsubscribe();
            if (votesUnsubscribe) votesUnsubscribe();
            
            gameUnsubscribe = db.collection('games').doc(currentGameId).onSnapshot(async (doc) => {
                if (!doc.exists) {
                    alert("Cette partie n'existe plus !");
                    window.location.reload();
                    return;
                }
                
                const gameData = doc.data();
                gameState = gameData;
                
                // Mettre √† jour la liste des joueurs
                await updatePlayersList();
                
                // G√©rer les diff√©rents √©tats du jeu
                switch (gameData.status) {
                    case GAME_PHASES.LOBBY:
                        // Mettre √† jour les param√®tres affich√©s
                        if (isGameCreator) {
                            document.getElementById('allow-spectators').checked = gameData.settings?.allowSpectators || false;
                            document.getElementById('auto-narrator').checked = gameData.settings?.narratorType !== 'manual';
                            document.getElementById('manual-narrator').checked = gameData.settings?.narratorType === 'manual';
                        }
                        break;
                        
                    case GAME_PHASES.ROLE_ASSIGNMENT:
                        // Attribuer les r√¥les
                        await assignRoles(gameData);
                        break;
                        
                    case GAME_PHASES.NIGHT:
                        // Configurer l'√©couteur des actions de nuit
                        setupNightActionsListener();
                        
                        // Jouer les sons appropri√©s
                        document.getElementById('night-sound').play();
                        document.getElementById('day-sound').pause();
                        
                        // Afficher l'√©cran de jeu si ce n'est pas d√©j√† fait
                        if (document.querySelector('.game-screen').style.display !== 'block') {
                            showGameScreen();
                        }
                        
                        // Afficher l'√©cran de r√¥le si le joueur ne conna√Æt pas encore son r√¥le
                        if (currentPlayerRole === "" && players[currentPlayerId]?.role) {
                            showRoleScreen(players[currentPlayerId].role);
                        }
                        
                        // Mettre √† jour l'interface
                        updateGameInterface();
                        break;
                        
                    case GAME_PHASES.DAY:
                    case GAME_PHASES.VOTING:
                        // Configurer l'√©couteur des votes
                        setupVotesListener();
                        
                        // Jouer les sons appropri√©s
                        document.getElementById('day-sound').play();
                        document.getElementById('night-sound').pause();
                        
                        // Afficher l'√©cran de jeu si ce n'est pas d√©j√† fait
                        if (document.querySelector('.game-screen').style.display !== 'block') {
                            showGameScreen();
                        }
                        
                        // Mettre √† jour l'interface
                        updateGameInterface();
                        break;
                        
                    case GAME_PHASES.END:
                        // Afficher l'√©cran de fin
                        showEndGameScreen();
                        break;
                }
            });
            
            // Configurer l'√©couteur du chat
            setupChatListener();
        }
        
        // Fonction pour configurer l'√©couteur des actions de nuit
        function setupNightActionsListener() {
            if (nightActionsUnsubscribe) nightActionsUnsubscribe();
            
            nightActionsUnsubscribe = db.collection('games').doc(currentGameId).collection('nightActions')
                .onSnapshot(async (snapshot) => {
                    if (!gameState || gameState.status !== GAME_PHASES.NIGHT) return;
                    
                    const playersSnapshot = await db.collection('games').doc(currentGameId).collection('players').get();
                    const alivePlayers = playersSnapshot.docs.filter(doc => doc.data().isAlive);
                    
                    // V√©rifier si toutes les actions n√©cessaires ont √©t√© effectu√©es
                    const requiredActions = getRequiredNightActions();
                    const actions = snapshot.docs.map(doc => doc.data());
                    
                    let allActionsCompleted = true;
                    
                    for (const role of requiredActions) {
                        const hasAction = actions.some(action => 
                            action.action.startsWith(role) && 
                            alivePlayers.some(player => player.id === action.from)
                        );
                        
                        if (!hasAction) {
                            allActionsCompleted = false;
                            break;
                        }
                    }
                    
                    // Si toutes les actions sont compl√©t√©es, passer √† la phase suivante
                    if (allActionsCompleted) {
                        proceedToNextPhase();
                    }
                });
        }
        
        // Fonction pour obtenir les actions de nuit requises selon la phase
        function getRequiredNightActions() {
            if (!gameState) return [];
            
            const required = [];
            const nightNumber = parseInt(gameState.phase.split('_')[1]);
            
            // Cupidon seulement la premi√®re nuit
            if (nightNumber === 1 && gameState.settings.roles.includes('CUPID')) {
                required.push('cupid');
            }
            
            // Loups-garous chaque nuit
            if (gameState.settings.roles.includes('WEREWOLF')) {
                required.push('werewolf');
            }
            
            // Voyante chaque nuit
            if (gameState.settings.roles.includes('SEER')) {
                required.push('seer');
            }
            
            // Sorci√®re chaque nuit
            if (gameState.settings.roles.includes('WITCH')) {
                required.push('witch');
            }
            
            return required;
        }
        
        // Fonction pour passer √† la phase suivante
        async function proceedToNextPhase() {
            if (!gameState) return;
            
            if (gameState.status === GAME_PHASES.NIGHT) {
                // Passer au jour
                await db.collection('games').doc(currentGameId).update({
                    status: GAME_PHASES.DAY,
                    phase: `day_${gameState.currentDay}`,
                    phaseStep: "discussion"
                });
                
                // Annoncer les victimes de la nuit
                announceNightVictims();
            } else if (gameState.status === GAME_PHASES.DAY) {
                // Passer au vote
                await db.collection('games').doc(currentGameId).update({
                    status: GAME_PHASES.VOTING,
                    phaseStep: "vote"
                });
            } else if (gameState.status === GAME_PHASES.VOTING) {
                // Compter les votes et √©liminer un joueur
                await processVotes();
                
                // V√©rifier si la partie est termin√©e
                if (await checkGameEnd()) {
                    return;
                }
                
                // Passer √† la nuit suivante
                await db.collection('games').doc(currentGameId).update({
                    status: GAME_PHASES.NIGHT,
                    phase: `night_${gameState.currentDay + 1}`,
                    phaseStep: NIGHT_PHASES.CUPID,
                    currentDay: gameState.currentDay + 1
                });
            }
        }
        
        // Fonction pour annoncer les victimes de la nuit
        async function announceNightVictims() {
            // Impl√©menter la logique pour d√©terminer qui est mort pendant la nuit
            // (victime des loups, potion de sorci√®re, etc.)
            // Afficher un message dans la narration
        }
        
        // Fonction pour traiter les votes
        async function processVotes() {
            const votesSnapshot = await db.collection('games').doc(currentGameId).collection('votes').get();
            const votes = votesSnapshot.docs.map(doc => doc.data().target);
            
            // Compter les votes
            const voteCount = {};
            votes.forEach(target => {
                voteCount[target] = (voteCount[target] || 0) + 1;
            });
            
            // Trouver le joueur avec le plus de votes
            let maxVotes = 0;
            let eliminatedPlayer = null;
            
            for (const [playerId, count] of Object.entries(voteCount)) {
                if (count > maxVotes) {
                    maxVotes = count;
                    eliminatedPlayer = playerId;
                }
            }
            
            // √âliminer le joueur
            if (eliminatedPlayer) {
                await db.collection('games').doc(currentGameId).collection('players').doc(eliminatedPlayer).update({
                    isAlive: false
                });
                
                // Si c'est le chasseur, lui permettre de tirer
                const eliminatedPlayerData = (await db.collection('games').doc(currentGameId).collection('players').doc(eliminatedPlayer).get()).data();
                if (eliminatedPlayerData.role === 'HUNTER') {
                    // Impl√©menter la logique du chasseur
                }
            }
            
            // Nettoyer les votes
            const batch = db.batch();
            votesSnapshot.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();
        }
        
        // Fonction pour v√©rifier si la partie est termin√©e
        async function checkGameEnd() {
            const playersSnapshot = await db.collection('games').doc(currentGameId).collection('players').get();
            const alivePlayers = playersSnapshot.docs.filter(doc => doc.data().isAlive);
            
            // V√©rifier si les amoureux ont gagn√©
            const lovers = alivePlayers.filter(doc => {
                const player = doc.data();
                return player.loverUid && players[player.loverUid]?.isAlive;
            });
            
            if (lovers.length >= 2 && alivePlayers.length === 2) {
                // Les amoureux gagnent
                await db.collection('games').doc(currentGameId).update({
                    status: GAME_PHASES.END,
                    winners: "lovers"
                });
                return true;
            }
            
            // V√©rifier si les loups-garous ont gagn√©
            const werewolves = alivePlayers.filter(doc => doc.data().role === 'WEREWOLF');
            const villagers = alivePlayers.filter(doc => doc.data().role !== 'WEREWOLF');
            
            if (werewolves.length >= villagers.length) {
                // Les loups-garous gagnent
                await db.collection('games').doc(currentGameId).update({
                    status: GAME_PHASES.END,
                    winners: "werewolves"
                });
                return true;
            }
            
            // V√©rifier si les villageois ont gagn√©
            if (werewolves.length === 0) {
                // Les villageois gagnent
                await db.collection('games').doc(currentGameId).update({
                    status: GAME_PHASES.END,
                    winners: "villagers"
                });
                return true;
            }
            
            return false;
        }
        
        // Fonction pour configurer l'√©couteur des votes
        function setupVotesListener() {
            if (votesUnsubscribe) votesUnsubscribe();
            
            votesUnsubscribe = db.collection('games').doc(currentGameId).collection('votes')
                .onSnapshot(async (snapshot) => {
                    if (!gameState || gameState.status !== GAME_PHASES.VOTING) return;
                    
                    const playersSnapshot = await db.collection('games').doc(currentGameId).collection('players').get();
                    const alivePlayers = playersSnapshot.docs.filter(doc => doc.data().isAlive);
                    
                    // Si tous les joueurs vivants ont vot√©, proc√©der
                    if (snapshot.size >= alivePlayers.length) {
                        proceedToNextPhase();
                    }
                });
        }
        
        // Fonction pour configurer l'√©couteur du chat
        function setupChatListener() {
            if (chatUnsubscribe) chatUnsubscribe();
            
            const chatPath = determineChatPath();
            if (!chatPath) return;
            
            chatUnsubscribe = db.collection('games').doc(currentGameId).collection('chats').doc(chatPath).collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot((snapshot) => {
                    const chatMessages = document.getElementById('chat-messages');
                    chatMessages.innerHTML = '';
                    
                    snapshot.forEach((doc) => {
                        const message = doc.data();
                        const messageElement = document.createElement('div');
                        messageElement.innerHTML = `<strong>${message.from}:</strong> ${message.text}`;
                        messageElement.style.marginBottom = '5px';
                        chatMessages.appendChild(messageElement);
                    });
                    
                    // Faire d√©filer vers le bas
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
        }
        
        // Fonction pour d√©terminer le chemin du chat selon le r√¥le et la phase
        function determineChatPath() {
            if (!gameState || !currentPlayerRole) return null;
            
            // Spectateurs voient toujours le chat des spectateurs
            if (players[currentPlayerId]?.type === 'spectator') {
                return 'spectators';
            }
            
            // Joueurs morts voient le chat des spectateurs
            if (!players[currentPlayerId]?.isAlive) {
                return 'spectators';
            }
            
            // Pendant la nuit, les loups ont leur propre chat
            if (gameState.status === GAME_PHASES.NIGHT && currentPlayerRole === 'WEREWOLF') {
                return 'werewolves';
            }
            
            // Sinon, chat g√©n√©ral
            return 'general';
        }
        
        // Fonction pour envoyer un message de chat
        async function sendChatMessage() {
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();
            
            if (!message || !currentPlayerName) return;
            
            const chatPath = determineChatPath();
            if (!chatPath) return;
            
            try {
                await db.collection('games').doc(currentGameId).collection('chats').doc(chatPath).collection('messages').add({
                    from: currentPlayerName,
                    text: message,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                chatInput.value = '';
            } catch (error) {
                console.error("Erreur lors de l'envoi du message:", error);
            }
        }
        
        // Fonction pour mettre √† jour la liste des joueurs
        async function updatePlayersList() {
            const playersSnapshot = await db.collection('games').doc(currentGameId).collection('players').get();
            players = {};
            
            const playerListElement = document.getElementById('player-list') || document.getElementById('alive-players');
            if (!playerListElement) return;
            
            playerListElement.innerHTML = '';
            
            playersSnapshot.forEach((doc) => {
                const player = doc.data();
                players[doc.id] = player;
                
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card pixel-border';
                playerCard.innerHTML = `
                    <div style="font-size: 2rem;">${player.role ? ROLES[player.role]?.emoji || 'üë§' : 'üë§'}</div>
                    <div>${player.pseudo}</div>
                    ${!player.isAlive ? '<div style="color: red;">‚ò†Ô∏è</div>' : ''}
                `;
                
                playerListElement.appendChild(playerCard);
            });
        }
        
        // Fonction pour mettre √† jour l'interface du jeu
        function updateGameInterface() {
            if (!gameState || !currentPlayerRole) return;
            
            // Mettre √† jour la phase affich√©e
            document.getElementById('game-phase').textContent = getPhaseDisplayName(gameState.phase);
            
            // Mettre √† jour la narration
            updateNarration();
            
            // Mettre √† jour les actions disponibles
            updateActionButtons();
            
            // Mettre √† jour le th√®me jour/nuit
            updateDayNightTheme();
        }
        
        // Fonction pour obtenir le nom affichable de la phase
        function getPhaseDisplayName(phase) {
            if (!phase) return "";
            
            if (phase.startsWith('night')) {
                const nightNumber = phase.split('_')[1];
                return `üåô Nuit ${nightNumber}`;
            } else if (phase.startsWith('day')) {
                const dayNumber = phase.split('_')[1];
                return `‚òÄÔ∏è Jour ${dayNumber}`;
            }
            
            return phase;
        }
        
        // Fonction pour mettre √† jour la narration
        function updateNarration() {
            const narrationBox = document.getElementById('narration-box');
            if (!narrationBox) return;
            
            let narrationText = "";
            
            if (gameState.status === GAME_PHASES.NIGHT) {
                if (currentPlayerRole === 'WEREWOLF') {
                    narrationText = "Les Loups-Garous se r√©veillent... Choisissez une victime !";
                } else if (currentPlayerRole === 'SEER') {
                    narrationText = "La Voyante se r√©veille... Choisissez un joueur dont vous voulez conna√Ætre le r√¥le.";
                } else if (currentPlayerRole === 'WITCH') {
                    narrationText = "La Sorci√®re se r√©veille... Voulez-vous utiliser une potion ?";
                } else if (currentPlayerRole === 'CUPID' && gameState.phase === 'night_1') {
                    narrationText = "Cupidon se r√©veille... Choisissez deux amoureux.";
                } else {
                    narrationText = "üåô Vous dormez profond√©ment...";
                }
            } else if (gameState.status === GAME_PHASES.DAY) {
                narrationText = "‚òÄÔ∏è Le village se r√©veille. Discutez pour trouver les Loups-Garous !";
            } else if (gameState.status === GAME_PHASES.VOTING) {
                narrationText = "üó≥Ô∏è C'est l'heure de voter ! Choisissez qui √©liminer.";
            }
            
            narrationBox.innerHTML = narrationText;
        }
        
        // Fonction pour mettre √† jour les boutons d'action
        function updateActionButtons() {
            const actionButtons = document.getElementById('action-buttons');
            if (!actionButtons) return;
            
            actionButtons.innerHTML = '';
            
            if (!players[currentPlayerId]?.isAlive) {
                // Joueur mort - pas d'actions
                return;
            }
            
            if (gameState.status === GAME_PHASES.NIGHT) {
                // Actions de nuit selon le r√¥le
                if (currentPlayerRole === 'WEREWOLF') {
                    // Afficher les joueurs vivants non loups
                    Object.entries(players).forEach(([id, player]) => {
                        if (player.isAlive && player.role !== 'WEREWOLF') {
                            const btn = document.createElement('button');
                            btn.className = 'pixel-button';
                            btn.textContent = `Voter pour ${player.pseudo}`;
                            btn.onclick = () => submitNightAction('werewolf_vote', id);
                            actionButtons.appendChild(btn);
                        }
                    });
                } else if (currentPlayerRole === 'SEER') {
                    // Afficher les joueurs √† espionner
                    Object.entries(players).forEach(([id, player]) => {
                        if (player.isAlive && id !== currentPlayerId) {
                            const btn = document.createElement('button');
                            btn.className = 'pixel-button';
                            btn.textContent = `Voir ${player.pseudo}`;
                            btn.onclick = () => submitNightAction('seer_peek', id);
                            actionButtons.appendChild(btn);
                        }
                    });
                } else if (currentPlayerRole === 'WITCH') {
                    // Afficher les options de potions
                    const btnHeal = document.createElement('button');
                    btnHeal.className = 'pixel-button';
                    btnHeal.textContent = 'Utiliser potion de vie';
                    btnHeal.onclick = () => submitNightAction('witch_heal', '');
                    actionButtons.appendChild(btnHeal);
                    
                    const btnKill = document.createElement('button');
                    btnKill.className = 'pixel-button';
                    btnKill.textContent = 'Utiliser potion de mort';
                    btnKill.onclick = () => submitNightAction('witch_kill', '');
                    actionButtons.appendChild(btnKill);
                } else if (currentPlayerRole === 'CUPID' && gameState.phase === 'night_1') {
                    // Afficher les joueurs pour Cupidon
                    const alivePlayers = Object.entries(players).filter(([id, player]) => player.isAlive && id !== currentPlayerId);
                    
                    if (alivePlayers.length >= 2) {
                        const select1 = document.createElement('select');
                        select1.className = 'pixel-input';
                        
                        const select2 = document.createElement('select');
                        select2.className = 'pixel-input';
                        
                        alivePlayers.forEach(([id, player]) => {
                            const option1 = document.createElement('option');
                            option1.value = id;
                            option1.textContent = player.pseudo;
                            select1.appendChild(option1);
                            
                            const option2 = document.createElement('option');
                            option2.value = id;
                            option2.textContent = player.pseudo;
                            select2.appendChild(option2);
                        });
                        
                        const btn = document.createElement('button');
                        btn.className = 'pixel-button';
                        btn.textContent = 'Lier ces deux joueurs';
                        btn.onclick = () => submitNightAction('cupid_match', [select1.value, select2.value]);
                        
                        actionButtons.appendChild(select1);
                        actionButtons.appendChild(select2);
                        actionButtons.appendChild(btn);
                    }
                }
            } else if (gameState.status === GAME_PHASES.VOTING) {
                // Afficher les joueurs pour le vote
                Object.entries(players).forEach(([id, player]) => {
                    if (player.isAlive && id !== currentPlayerId) {
                        const btn = document.createElement('button');
                        btn.className = 'pixel-button';
                        btn.textContent = `Voter contre ${player.pseudo}`;
                        btn.onclick = () => submitVote(id);
                        actionButtons.appendChild(btn);
                    }
                });
            }
        }
        
        // Fonction pour soumettre une action de nuit
        async function submitNightAction(actionType, target) {
            try {
                await db.collection('games').doc(currentGameId).collection('nightActions').doc(currentPlayerId).set({
                    action: actionType,
                    target: target,
                    from: currentPlayerId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error("Erreur lors de la soumission de l'action:", error);
            }
        }
        
        // Fonction pour soumettre un vote
        async function submitVote(targetPlayerId) {
            try {
                await db.collection('games').doc(currentGameId).collection('votes').doc(currentPlayerId).set({
                    target: targetPlayerId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error("Erreur lors de la soumission du vote:", error);
            }
        }
        
        // Fonction pour mettre √† jour le th√®me jour/nuit
        function updateDayNightTheme() {
            if (gameState.status === GAME_PHASES.NIGHT) {
                document.body.classList.add('night-mode');
            } else {
                document.body.classList.remove('night-mode');
            }
        }
        
        // Fonction pour afficher l'√©cran de fin de partie
        function showEndGameScreen() {
            const winners = determineWinners();
            
            const narrationBox = document.getElementById('narration-box');
            if (narrationBox) {
                narrationBox.innerHTML = `
                    <h2>Partie termin√©e !</h2>
                    <p>Les ${winners.team} ont gagn√© !</p>
                    <p>${winners.message}</p>
                    <div style="margin-top: 20px;">
                        ${winners.players.map(p => `<div>${p.pseudo} (${ROLES[p.role]?.name || 'Inconnu'})</div>`).join('')}
                    </div>
                `;
            }
            
            // Afficher un bouton pour rejouer
            const actionButtons = document.getElementById('action-buttons');
            if (actionButtons) {
                actionButtons.innerHTML = '';
                
                if (isGameCreator) {
                    const btn = document.createElement('button');
                    btn.className = 'pixel-button';
                    btn.textContent = 'Rejouer avec le m√™me groupe';
                    btn.onclick = restartGame;
                    actionButtons.appendChild(btn);
                }
                
                const btnLeave = document.createElement('button');
                btnLeave.className = 'pixel-button';
                btnLeave.textContent = 'Quitter la partie';
                btnLeave.onclick = leaveGame;
                actionButtons.appendChild(btnLeave);
            }
        }
        
        // Fonction pour d√©terminer les gagnants
        function determineWinners() {
            // Logique simplifi√©e - √† compl√©ter selon les r√®gles exactes
            const alivePlayers = Object.values(players).filter(p => p.isAlive);
            
            // V√©rifier si les amoureux ont gagn√©
            const lovers = alivePlayers.filter(p => p.loverUid && players[p.loverUid]?.isAlive);
            if (lovers.length >= 2 && alivePlayers.length === 2) {
                return {
                    team: "Amoureux",
                    message: "Les amoureux survivent seuls et remportent la partie !",
                    players: lovers
                };
            }
            
            // V√©rifier si les loups-garous ont gagn√©
            const werewolves = alivePlayers.filter(p => p.role === 'WEREWOLF');
            const villagers = alivePlayers.filter(p => p.role !== 'WEREWOLF');
            
            if (werewolves.length >= villagers.length) {
                return {
                    team: "Loups-Garous",
                    message: "Les loups-garous ont √©limin√© tous les villageois !",
                    players: werewolves
                };
            } else {
                return {
                    team: "Villageois",
                    message: "Les villageois ont √©limin√© tous les loups-garous !",
                    players: villagers
                };
            }
        }
        
        // Fonction pour red√©marrer une partie
        async function restartGame() {
            if (!isGameCreator) return;
            
            try {
                // R√©initialiser la partie
                await db.collection('games').doc(currentGameId).update({
                    status: GAME_PHASES.ROLE_ASSIGNMENT,
                    phase: "night_1",
                    phaseStep: NIGHT_PHASES.CUPID,
                    currentDay: 1
                });
                
                // R√©initialiser les joueurs
                const batch = db.batch();
                const playersSnapshot = await db.collection('games').doc(currentGameId).collection('players').get();
                
                playersSnapshot.forEach(doc => {
                    const ref = db.collection('games').doc(currentGameId).collection('players').doc(doc.id);
                    batch.update(ref, {
                        role: "",
                        isAlive: true,
                        loverUid: null
                    });
                });
                
                await batch.commit();
                
                // Supprimer les anciens messages et actions
                await clearGameData();
                
            } catch (error) {
                console.error("Erreur lors du red√©marrage de la partie:", error);
            }
        }
        
        // Fonction pour quitter la partie
        function leaveGame() {
            sessionStorage.removeItem('gameId');
            window.location.reload();
        }
        
        // Fonction pour nettoyer les donn√©es de la partie
        async function clearGameData() {
            const chats = ['general', 'werewolves', 'spectators'];
            const batch = db.batch();
            
            // Supprimer les messages de chat
            for (const chat of chats) {
                const messages = await db.collection('games').doc(currentGameId).collection('chats').doc(chat).collection('messages').get();
                messages.forEach(doc => {
                    batch.delete(doc.ref);
                });
            }
            
            // Supprimer les actions de nuit
            const nightActions = await db.collection('games').doc(currentGameId).collection('nightActions').get();
            nightActions.forEach(doc => {
                batch.delete(doc.ref);
            });
            
            // Supprimer les votes
            const votes = await db.collection('games').doc(currentGameId).collection('votes').get();
            votes.forEach(doc => {
                batch.delete(doc.ref);
            });
            
            await batch.commit();
        }
        
        // Fonction pour g√©n√©rer un ID de partie
        function generateGameId() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 5; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // Fonction pour m√©langer un tableau
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
    </script>
</body>
</html>
