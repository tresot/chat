<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Village - Jeu multijoueur</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* [Tous vos styles CSS existants restent inchang√©s] */
                /* Reset et base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            image-rendering: pixelated;
        }
        
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #1a1a2e;
            color: #e6e6e6;
            line-height: 1.6;
            overflow-x: hidden;
            background-image: url('https://img.freepik.com/free-vector/pixel-art-rural-landscape-background_52683-87941.jpg');
            background-size: cover;
            background-attachment: fixed;
        }
        
        /* Animation de feu de camp */
        @keyframes campfire {
            0% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
            100% { opacity: 0.8; transform: scale(1); }
        }
        
        .campfire {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 100px;
            height: 100px;
            background-image: url('https://www.pikpng.com/pngl/m/430-4309657_pixel-campfire-pixel-art-bonfire-clipart.png');
            background-size: contain;
            background-repeat: no-repeat;
            animation: campfire 2s infinite;
            z-index: 1;
            pointer-events: none;
            filter: drop-shadow(0 0 10px #ff6b00);
        }
        
        /* √âtoiles scintillantes */
        @keyframes twinkle {
            0% { opacity: 0.2; }
            50% { opacity: 1; }
            100% { opacity: 0.2; }
        }
        
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%"><circle cx="10%" cy="15%" r="1" fill="white"/><circle cx="25%" cy="30%" r="1" fill="white"/><circle cx="50%" cy="10%" r="1" fill="white"/><circle cx="75%" cy="25%" r="1" fill="white"/><circle cx="90%" cy="40%" r="1" fill="white"/><circle cx="15%" cy="70%" r="1" fill="white"/><circle cx="40%" cy="80%" r="1" fill="white"/><circle cx="60%" cy="60%" r="1" fill="white"/><circle cx="85%" cy="75%" r="1" fill="white"/></svg>');
            z-index: -1;
            pointer-events: none;
        }
        
        .night-mode .stars {
            animation: twinkle 3s infinite;
        }
        
        /* Styles globaux pixel art */
        .pixel-border {
            border: 4px solid #4a4a4a;
            border-image: repeating-linear-gradient(45deg, #4a4a4a, #4a4a4a 2px, #333 2px, #333 4px) 4;
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
            background-color: #2d2d44;
            position: relative;
            overflow: hidden;
        }
        
        .pixel-border::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #4a752c, #6a953c);
        }
        
        .pixel-button {
            background-color: #4a752c;
            color: white;
            border: none;
            padding: 12px 24px;
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            margin: 10px;
            text-shadow: 2px 2px 0 #1a1a2e;
        }
        
        .pixel-button:hover {
            background-color: #5e8c3e;
            transform: translate(-2px, -2px);
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
        }
        
        .pixel-button:active {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0 rgba(0, 0, 0, 0.3);
        }
        
        .pixel-input {
            background-color: #2d2d44;
            border: 3px solid #4a4a4a;
            padding: 10px;
            font-family: 'Press Start 2P', cursive;
            color: white;
            margin: 10px 0;
            width: 100%;
            max-width: 300px;
        }
        
        /* Animation d'√©criture */
        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }
        
        .typing-animation {
            overflow: hidden;
            white-space: nowrap;
            animation: typing 3s steps(40, end);
        }
        
        /* Layout principal */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 2;
        }
        
        /* Page d'accueil */
        .home-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            position: relative;
        }
        
        .game-title {
            font-size: 3rem;
            margin-bottom: 2rem;
            color: #f0f0f0;
            text-shadow: 4px 4px 0 #4a752c, 8px 8px 0 #1a1a2e;
            position: relative;
        }
        
        .game-title::after {
            content: "";
            display: block;
            width: 100%;
            height: 8px;
            background: linear-gradient(90deg, #4a752c, #6a953c);
            margin-top: 10px;
        }
        
        .player-form {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: rgba(26, 26, 46, 0.8);
            padding: 2rem;
            border-radius: 8px;
            position: relative;
            backdrop-filter: blur(5px);
        }
        
        /* Animation soleil/lune */
        .sun-moon {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-image: url('https://www.pikpng.com/pngl/m/430-4309657_pixel-campfire-pixel-art-bonfire-clipart.png');
            background-size: contain;
            z-index: 10;
            transition: transform 1s;
        }
        
        .night-mode .sun-moon {
            background-image: url('https://www.pikpng.com/pngl/m/430-4309657_pixel-campfire-pixel-art-bonfire-clipart.png');
            transform: rotate(180deg);
        }
        
        /* Lobby */
        .lobby-screen {
            display: none;
            min-height: 100vh;
            padding: 20px;
        }
        
        .player-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .player-card {
            background-color: #2d2d44;
            padding: 15px;
            border-radius: 8px;
            width: 150px;
            text-align: center;
            position: relative;
            transition: transform 0.3s;
        }
        
        .player-card:hover {
            transform: translateY(-5px);
        }
        
        .player-card::after {
            content: "";
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 5px;
            background-color: #4a752c;
        }
        
        /* √âcran de jeu */
        .game-screen {
            display: none;
            min-height: 100vh;
            padding: 20px;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .game-phase {
            font-size: 1.5rem;
            color: #f0f0f0;
            text-shadow: 2px 2px 0 #1a1a2e;
        }
        
        .game-timer {
            font-size: 1.2rem;
            color: #f0f0f0;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
        }
        
        .narration-box {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #4a752c;
            position: relative;
        }
        
        .narration-box::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #4a752c, #6a953c);
        }
        
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 300px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
        }
        
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background-color: rgba(26, 26, 46, 0.5);
            border-radius: 5px;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex-grow: 1;
            padding: 10px;
            font-family: 'Press Start 2P', cursive;
            background-color: #2d2d44;
            color: white;
            border: none;
            border-radius: 5px;
        }
        
        /* √âcran de r√¥le */
        .role-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            backdrop-filter: blur(5px);
        }
        
        .role-emoji {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .role-description {
            font-size: 1.5rem;
            margin-bottom: 30px;
            max-width: 80%;
            line-height: 1.8;
        }
        
        /* Mode nuit */
        .night-mode {
            background-color: #0a0a1a;
            color: #a0a0a0;
        }
        
        .night-mode .pixel-button {
            background-color: #3a3a6a;
        }
        
        /* Animation de transition */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 1s ease-in;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4a752c;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from { top: -50px; opacity: 0; }
            to { top: 20px; opacity: 1; }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .game-title {
                font-size: 2rem;
            }
            
            .player-card {
                width: 120px;
                font-size: 0.8rem;
            }
            
            .role-description {
                font-size: 1rem;
            }
            
            .pixel-button {
                padding: 8px 16px;
                font-size: 12px;
            }
        }
        /* ... */
    </style>
</head>
<body>
    <!-- [Tous vos √©l√©ments HTML existants restent inchang√©s] -->
        <!-- √âl√©ments d'arri√®re-plan -->
    <div class="stars"></div>
    <div class="campfire"></div>
    <div class="sun-moon"></div>
    
    <!-- √âcran d'accueil -->
    <div class="home-screen fade-in">
        <div class="container">
            <h1 class="game-title">LE VILLAGE</h1>
            <div class="player-form pixel-border">
                <input type="text" id="player-name" class="pixel-input" placeholder="Ton pseudo" maxlength="15">
                <button id="create-game-btn" class="pixel-button">Cr√©er une partie</button>
                <div style="margin: 15px 0; position: relative;">
                    <div style="position: absolute; top: 50%; left: 0; right: 0; height: 2px; background-color: #4a4a4a;"></div>
                    <span style="background-color: #1a1a2e; padding: 0 10px; position: relative;">OU</span>
                </div>
                <input type="text" id="game-id" class="pixel-input" placeholder="Code de la partie">
                <button id="join-game-btn" class="pixel-button">Rejoindre</button>
            </div>
        </div>
    </div>
    
    <!-- Lobby -->
    <div class="lobby-screen pixel-border">
        <div class="container">
            <h2>Place du Village</h2>
            <p id="game-code-display">Code de la partie: </p>
            <div class="player-list" id="player-list">
                <!-- Joueurs seront ajout√©s ici dynamiquement -->
            </div>
            
            <div id="game-settings" style="margin-top: 30px;">
                <h3>Param√®tres de la partie</h3>
                <div id="role-selection" style="margin: 15px 0;">
                    <h4>R√¥les disponibles:</h4>
                    <!-- Cases √† cocher pour les r√¥les -->
                </div>
                
                <div style="margin: 15px 0;">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="allow-spectators" class="pixel-input" style="width: auto;">
                        Autoriser les spectateurs
                    </label>
                </div>
                
                <div style="margin: 15px 0;">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="radio" name="narrator" id="auto-narrator" checked class="pixel-input" style="width: auto;">
                        Narration automatique
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="radio" name="narrator" id="manual-narrator" class="pixel-input" style="width: auto;">
                        Narration manuelle
                    </label>
                </div>
                
                <button id="start-game-btn" class="pixel-button" disabled>Commencer la nuit</button>
            </div>
        </div>
    </div>
    
    <!-- √âcran de jeu principal -->
    <div class="game-screen pixel-border">
        <div class="container">
            <div class="game-header">
                <div class="game-phase" id="game-phase">‚òÄÔ∏è Jour 1</div>
                <div class="game-timer" id="game-timer">‚è±Ô∏è 02:00</div>
            </div>
            
            <div class="narration-box" id="narration-box">
                <!-- Narration du jeu -->
            </div>
            
            <div class="action-buttons" id="action-buttons">
                <!-- Boutons d'action selon le r√¥le et la phase -->
            </div>
            
            <div class="player-list" id="alive-players">
                <!-- Joueurs en vie -->
            </div>
            
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <!-- Messages de chat -->
                </div>
                <div class="chat-input-container">
                    <input type="text" id="chat-input" class="chat-input" placeholder="√âcrire un message...">
                    <button id="send-chat-btn" class="pixel-button" style="margin: 0;">Envoyer</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- √âcran de r√¥le -->
    <div class="role-screen" id="role-screen">
        <div class="role-emoji" id="role-emoji">üë§</div>
        <div class="role-description" id="role-description">Tu es un Villageois</div>
        <button id="confirm-role-btn" class="pixel-button">Je suis pr√™t</button>
    </div>
    
    <!-- Sons du jeu -->
    <audio id="bg-music" loop>
        <source src="https://assets.codepen.io/21542/stardew-valley-theme.mp3" type="audio/mpeg">
    </audio>
    <audio id="night-sound">
        <source src="https://assets.codepen.io/21542/werewolf-how.mp3" type="audio/mpeg">
    </audio>
    <audio id="day-sound">
        <source src="https://assets.codepen.io/21542/birds-chirping.mp3" type="audio/mpeg">
    </audio>
    <audio id="join-sound">
        <source src="https://assets.codepen.io/21542/door-open.mp3" type="audio/mpeg">
    </audio>
    <audio id="leave-sound">
        <source src="https://assets.codepen.io/21542/door-close.mp3" type="audio/mpeg">
    </audio>
    <audio id="vote-sound">
        <source src="https://assets.codepen.io/21542/click-sound.mp3" type="audio/mpeg">
    </audio>
    
    <!-- Firebase et scripts du jeu -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <!-- ... -->
    
    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAfWw2bWiJEfVrYDBhCuaG65b55qhbVma0",
            authDomain: "chat-entre-amis.firebaseapp.com",
            projectId: "chat-entre-amis",
            storageBucket: "chat-entre-amis.appspot.com",
            messagingSenderId: "515377701483",
            appId: "1:515377701483:web:0f81538de26d5904f9472e"
        };
        
        // Initialisation Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Variables globales optimis√©es
        let currentGameId = null;
        let currentPlayerId = null;
        let currentPlayerName = "";
        let currentPlayerRole = "";
        let isGameCreator = false;
        let gameState = {};
        let players = {};
        let unsubscribeFunctions = [];
        let presenceInterval = null;
        let isPlayerOnline = true;

        // Constantes du jeu
        const ROLES = {
            VILLAGER: { emoji: "üë§", name: "Villageois", description: "Ton but est d'√©liminer tous les Loups-Garous." },
            WEREWOLF: { emoji: "üê∫", name: "Loup-Garou", description: "Chaque nuit, choisis une victime avec tes comp√®res." },
            SEER: { emoji: "üîÆ", name: "Voyante", description: "Tu peux d√©couvrir le r√¥le d'un joueur chaque nuit." },
            WITCH: { emoji: "üßô", name: "Sorci√®re", description: "Tu poss√®des une potion de vie et une potion de mort." },
            CUPID: { emoji: "üíò", name: "Cupidon", description: "Forme un couple de deux joueurs qui devront survivre ensemble." },
            HUNTER: { emoji: "üèπ", name: "Chasseur", description: "Si tu meurs, tu peux emporter quelqu'un avec toi." },
            LITTLE_GIRL: { emoji: "üëß", name: "Petite Fille", description: "Tu peux espionner les Loups-Garous la nuit." }
        };
        
        const GAME_PHASES = {
            LOBBY: "lobby",
            ROLE_ASSIGNMENT: "role_assignment",
            NIGHT: "night",
            DAY: "day",
            VOTING: "voting",
            END: "end"
        };
        
        const NIGHT_PHASES = {
            CUPID: "cupid",
            WEREWOLVES: "werewolves",
            SEER: "seer",
            WITCH: "witch"
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            initGame();
            setupEventListeners();
        });

        function initGame() {
            try {
                const bgMusic = document.getElementById('bg-music');
                bgMusic.volume = 0.3;
                bgMusic.play().catch(e => console.log("Autoplay blocked:", e));
            } catch (e) {
                console.error("Audio error:", e);
            }
        }

        function setupEventListeners() {
            document.getElementById('create-game-btn').addEventListener('click', createGame);
            document.getElementById('join-game-btn').addEventListener('click', joinGame);
            document.getElementById('start-game-btn').addEventListener('click', startGame);
            document.getElementById('confirm-role-btn').addEventListener('click', confirmRole);
            document.getElementById('send-chat-btn').addEventListener('click', sendChatMessage);
            
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });
            
            // Gestion am√©lior√©e des d√©connexions
            window.addEventListener('beforeunload', handleBeforeUnload);
            window.addEventListener('pagehide', handleBeforeUnload);
            window.addEventListener('visibilitychange', handleVisibilityChange);
            
            checkReturningPlayer();
        }

        // Gestion optimis√©e de la pr√©sence
        function handleVisibilityChange() {
            if (document.visibilityState === 'hidden') {
                isPlayerOnline = false;
                updatePlayerPresence(false);
            } else {
                isPlayerOnline = true;
                updatePlayerPresence(true);
            }
        }

        async function handleBeforeUnload() {
            if (currentGameId && currentPlayerId) {
                try {
                    await db.collection('games').doc(currentGameId).collection('players')
                        .doc(currentPlayerId).update({
                            isOnline: false,
                            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                        });
                } catch (error) {
                    console.error("Error updating player status:", error);
                }
                clearAllIntervals();
                unsubscribeAllListeners();
            }
        }

        function clearAllIntervals() {
            if (presenceInterval) clearInterval(presenceInterval);
        }

        function unsubscribeAllListeners() {
            unsubscribeFunctions.forEach(unsub => unsub());
            unsubscribeFunctions = [];
        }

        // Fonction optimis√©e pour cr√©er une partie
        async function createGame() {
            const playerName = document.getElementById('player-name').value.trim();
            if (!playerName) {
                showNotification("Choisis un pseudo !");
                return;
            }
            
            currentPlayerName = playerName;
            sessionStorage.setItem('playerName', playerName);
            
            try {
                // Authentification d'abord
                await auth.signInAnonymously();
                currentPlayerId = auth.currentUser.uid;
                isGameCreator = true;
                
                // G√©n√©ration unique du code de partie
                let gameExists = true;
                let attempts = 0;
                while (gameExists && attempts < 5) {
                    currentGameId = generateGameId();
                    const doc = await db.collection('games').doc(currentGameId).get();
                    gameExists = doc.exists;
                    attempts++;
                    if (gameExists) await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                if (gameExists) {
                    showNotification("Erreur de cr√©ation, r√©essaye !");
                    return;
                }

                // Cr√©ation atomique de la partie avec batch
                const batch = db.batch();
                const gameRef = db.collection('games').doc(currentGameId);
                const playerRef = gameRef.collection('players').doc(currentPlayerId);
                
                batch.set(gameRef, {
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: GAME_PHASES.LOBBY,
                    settings: {
                        roles: Object.keys(ROLES),
                        allowSpectators: false,
                        narratorType: "auto"
                    },
                    creatorId: currentPlayerId,
                    currentDay: 1
                });
                
                batch.set(playerRef, {
                    pseudo: currentPlayerName,
                    role: "",
                    isAlive: true,
                    isOnline: true,
                    type: "player",
                    score: 0,
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await batch.commit();
                
                showLobbyScreen();
                setupGameListeners();
                startPresenceUpdates();
                document.getElementById('join-sound').play();
                
            } catch (error) {
                console.error("Erreur cr√©ation partie:", error);
                showNotification("Erreur de cr√©ation. V√©rifie ta connexion.");
            }
        }

        // Fonction optimis√©e pour rejoindre une partie
        async function joinGame() {
            const playerName = document.getElementById('player-name').value.trim();
            const gameId = document.getElementById('game-id').value.trim().toUpperCase();
            
            if (!playerName) {
                showNotification("Choisis un pseudo !");
                return;
            }
            
            if (!gameId) {
                showNotification("Entre le code de la partie !");
                return;
            }
            
            currentPlayerName = playerName;
            currentGameId = gameId;
            sessionStorage.setItem('playerName', playerName);
            sessionStorage.setItem('gameId', gameId);
            
            try {
                // V√©rification rapide de l'existence de la partie
                const gameDoc = await db.collection('games').doc(gameId).get();
                if (!gameDoc.exists) {
                    showNotification("Aucune partie trouv√©e avec ce code !");
                    return;
                }
                
                if (gameDoc.data().status !== GAME_PHASES.LOBBY) {
                    showNotification("Cette partie a d√©j√† commenc√© !");
                    return;
                }
                
                // Authentification
                await auth.signInAnonymously();
                currentPlayerId = auth.currentUser.uid;
                
                // Ajout/MAJ du joueur en une seule op√©ration
                await db.collection('games').doc(gameId).collection('players')
                    .doc(currentPlayerId).set({
                        pseudo: currentPlayerName,
                        role: "",
                        isAlive: true,
                        isOnline: true,
                        type: "player",
                        score: 0,
                        joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                
                showLobbyScreen();
                setupGameListeners();
                startPresenceUpdates();
                document.getElementById('join-sound').play();
                
            } catch (error) {
                console.error("Erreur connexion partie:", error);
                showNotification("Erreur de connexion. V√©rifie ta connexion.");
            }
        }

        // Gestion optimis√©e de la pr√©sence
        function startPresenceUpdates() {
            clearInterval(presenceInterval);
            
            // Mise √† jour moins fr√©quente (toutes les 20 secondes)
            presenceInterval = setInterval(() => {
                if (currentGameId && currentPlayerId && isPlayerOnline) {
                    updatePlayerPresence(true);
                }
            }, 20000);
        }

        async function updatePlayerPresence(online) {
            try {
                await db.collection('games').doc(currentGameId).collection('players')
                    .doc(currentPlayerId).update({
                        isOnline: online,
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
            } catch (error) {
                console.error("Error updating presence:", error);
            }
        }

        // Configuration des listeners optimis√©s
        function setupGameListeners() {
            unsubscribeAllListeners();
            
            // Listener principal de la partie
            const gameUnsub = db.collection('games').doc(currentGameId)
                .onSnapshot(handleGameUpdate, handleGameError);
            unsubscribeFunctions.push(gameUnsub);
            
            // Listener optimis√© des joueurs
            const playersUnsub = db.collection('games').doc(currentGameId).collection('players')
                .onSnapshot(handlePlayersUpdate, handleGameError);
            unsubscribeFunctions.push(playersUnsub);
            
            // Listener de chat optimis√©
            setupChatListener();
        }

        async function handleGameUpdate(doc) {
            if (!doc.exists) {
                showNotification("Cette partie n'existe plus !");
                setTimeout(() => window.location.reload(), 2000);
                return;
            }

            gameState = doc.data();
            
            // Gestion des phases du jeu
            switch (gameState.status) {
                case GAME_PHASES.LOBBY:
                    updateLobbySettings();
                    break;
                    
                case GAME_PHASES.ROLE_ASSIGNMENT:
                    await assignRoles();
                    break;
                    
                case GAME_PHASES.NIGHT:
                    setupNightPhase();
                    break;
                    
                case GAME_PHASES.DAY:
                case GAME_PHASES.VOTING:
                    setupDayPhase();
                    break;
                    
                case GAME_PHASES.END:
                    showEndGameScreen();
                    break;
            }
            
            updateGameInterface();
        }

        function handleGameError(error) {
            console.error("Game listener error:", error);
            showNotification("Erreur de connexion au serveur");
        }

        async function handlePlayersUpdate(snapshot) {
            players = {};
            const now = new Date();
            
            snapshot.forEach(doc => {
                const player = doc.data();
                players[doc.id] = player;
            });
            
            // Mise √† jour optimis√©e de l'affichage
            updatePlayersDisplay();
            
            // Gestion des notifications de joueurs
            snapshot.docChanges().forEach(change => {
                if (change.type === 'added' && change.doc.id !== currentPlayerId) {
                    showNotification(`${change.doc.data().pseudo} a rejoint !`);
                    document.getElementById('join-sound').play();
                } else if (change.type === 'removed') {
                    showNotification(`${change.doc.data().pseudo} a quitt√©.`);
                    document.getElementById('leave-sound').play();
                }
            });
        }

        // Fonction optimis√©e pour afficher le lobby
        function showLobbyScreen() {
            document.querySelector('.home-screen').style.display = 'none';
            document.querySelector('.lobby-screen').style.display = 'block';
            document.querySelector('.game-screen').style.display = 'none';
            
            document.getElementById('game-code-display').textContent = `Code: ${currentGameId}`;
            
            if (isGameCreator) {
                document.getElementById('game-settings').style.display = 'block';
                document.getElementById('start-game-btn').disabled = false;
                setupRoleSelection();
            } else {
                document.getElementById('game-settings').style.display = 'none';
                document.getElementById('start-game-btn').disabled = true;
            }
        }

        function setupRoleSelection() {
            const roleSelection = document.getElementById('role-selection');
            roleSelection.innerHTML = '<h4>R√¥les disponibles:</h4>';
            
            Object.entries(ROLES).forEach(([key, role]) => {
                const div = document.createElement('div');
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.gap = '10px';
                div.style.margin = '5px 0';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `role-${key}`;
                checkbox.value = key;
                checkbox.checked = true;
                checkbox.className = 'pixel-input';
                checkbox.style.width = 'auto';
                
                const label = document.createElement('label');
                label.htmlFor = `role-${key}`;
                label.textContent = `${role.emoji} ${role.name}`;
                
                div.appendChild(checkbox);
                div.appendChild(label);
                roleSelection.appendChild(div);
            });
        }

        // Fonction optimis√©e pour d√©marrer le jeu
        async function startGame() {
            if (!isGameCreator) return;
            
            // R√©cup√©ration des r√¥les s√©lectionn√©s
            const selectedRoles = [];
            document.querySelectorAll('#role-selection input[type="checkbox"]:checked')
                .forEach(checkbox => selectedRoles.push(checkbox.value));
            
            if (selectedRoles.length === 0) {
                showNotification("S√©lectionne au moins un r√¥le !");
                return;
            }
            
            // V√©rification du nombre de joueurs
            const playersSnapshot = await db.collection('games').doc(currentGameId).collection('players').get();
            if (playersSnapshot.size < 4) {
                showNotification("Il faut au moins 4 joueurs !");
                return;
            }
            
            // Mise √† jour atomique des param√®tres
            await db.collection('games').doc(currentGameId).update({
                'settings.roles': selectedRoles,
                'settings.allowSpectators': document.getElementById('allow-spectators').checked,
                'settings.narratorType': document.getElementById('auto-narrator').checked ? 'auto' : 'manual',
                status: GAME_PHASES.ROLE_ASSIGNMENT
            });
        }

        // Fonction optimis√©e pour attribuer les r√¥les
        async function assignRoles() {
            const playersSnapshot = await db.collection('games').doc(currentGameId).collection('players').get();
            const playersList = playersSnapshot.docs.map(doc => doc.id);
            const availableRoles = [...gameState.settings.roles];
            
            // Calcul du nombre de loups-garous
            const werewolvesCount = Math.max(1, Math.floor(playersList.length / 4));
            
            // M√©lange des r√¥les
            shuffleArray(availableRoles);
            
            // Attribution des r√¥les avec batch
            const batch = db.batch();
            let werewolvesAssigned = 0;
            
            playersList.forEach(playerId => {
                const playerRef = db.collection('games').doc(currentGameId).collection('players').doc(playerId);
                let role;
                
                if (werewolvesAssigned < werewolvesCount && availableRoles.includes('WEREWOLF')) {
                    role = 'WEREWOLF';
                    werewolvesAssigned++;
                } else {
                    role = availableRoles.length > 0 ? availableRoles.shift() : 'VILLAGER';
                }
                
                batch.update(playerRef, {
                    role: role,
                    isAlive: true,
                    loverUid: null
                });
            });
            
            await batch.commit();
            
            // Passage √† la premi√®re nuit
            await db.collection('games').doc(currentGameId).update({
                status: GAME_PHASES.NIGHT,
                phase: "night_1",
                phaseStep: NIGHT_PHASES.CUPID,
                currentDay: 1
            });
        }

        // [Les autres fonctions restent similaires mais avec les optimisations appliqu√©es]
        // ... (showRoleScreen, confirmRole, showGameScreen, etc.)

        // Fonction pour quitter proprement
        async function leaveGame() {
            try {
                if (currentGameId && currentPlayerId) {
                    await db.collection('games').doc(currentGameId).collection('players')
                        .doc(currentPlayerId).update({
                            isOnline: false,
                            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                        });
                }
            } catch (error) {
                console.error("Leave error:", error);
            } finally {
                sessionStorage.removeItem('gameId');
                window.location.reload();
            }
        }

        // Fonctions utilitaires inchang√©es
        function generateGameId() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 5; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
    </script>
</body>
</html>
